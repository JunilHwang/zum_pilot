<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>서버 사이드 | 주제별 영상제공 웹 서비스</title>
    <meta name="description" content="Zuminternet Pilot Project">
    
    
    <link rel="preload" href="/zum_pilot/assets/css/0.styles.c36e5045.css" as="style"><link rel="preload" href="/zum_pilot/assets/js/app.6c4eeaf4.js" as="script"><link rel="preload" href="/zum_pilot/assets/js/10.b9f48cc9.js" as="script"><link rel="preload" href="/zum_pilot/assets/js/2.1b64034b.js" as="script"><link rel="preload" href="/zum_pilot/assets/js/7.f435671a.js" as="script"><link rel="prefetch" href="/zum_pilot/assets/js/11.b9f3a89c.js"><link rel="prefetch" href="/zum_pilot/assets/js/12.772e3a57.js"><link rel="prefetch" href="/zum_pilot/assets/js/13.cb40e1eb.js"><link rel="prefetch" href="/zum_pilot/assets/js/14.cee7c745.js"><link rel="prefetch" href="/zum_pilot/assets/js/15.2ad31dae.js"><link rel="prefetch" href="/zum_pilot/assets/js/16.466cb64c.js"><link rel="prefetch" href="/zum_pilot/assets/js/3.6304e16f.js"><link rel="prefetch" href="/zum_pilot/assets/js/4.54e2eed6.js"><link rel="prefetch" href="/zum_pilot/assets/js/5.c1faf1f1.js"><link rel="prefetch" href="/zum_pilot/assets/js/6.32db1964.js"><link rel="prefetch" href="/zum_pilot/assets/js/8.4ffa0421.js"><link rel="prefetch" href="/zum_pilot/assets/js/9.f1913e30.js">
    <link rel="stylesheet" href="/zum_pilot/assets/css/0.styles.c36e5045.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zum_pilot/" class="home-link router-link-active"><img src="/zum_pilot/img/logo.gif" alt="주제별 영상제공 웹 서비스" class="logo"> <span class="site-name can-hide">주제별 영상제공 웹 서비스</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/JunilHwang/zum_pilot/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/JunilHwang/zum_pilot/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Repository
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/zum_pilot/" class="sidebar-link">프로젝트 개요</a></li><li><a href="/zum_pilot/Result/" class="sidebar-link">결과물 소개</a></li><li><a href="/zum_pilot/Timeline/" class="sidebar-link">프로젝트 일정 관리</a></li><li><a href="/zum_pilot/Architecture/" class="sidebar-link">프로젝트 아키텍쳐</a></li><li><a href="/zum_pilot/Design/" class="sidebar-link">프로젝트 설계</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>클라이언트 사이드</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/zum_pilot/Server/" class="active sidebar-link">서버 사이드</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zum_pilot/Server/#_1-crawling" class="sidebar-link">1. Crawling</a></li><li class="sidebar-sub-header"><a href="/zum_pilot/Server/#_2-youtube-search" class="sidebar-link">2. Youtube Search</a></li><li class="sidebar-sub-header"><a href="/zum_pilot/Server/#_3-authorization" class="sidebar-link">3. Authorization</a></li><li class="sidebar-sub-header"><a href="/zum_pilot/Server/#_4-authentication" class="sidebar-link">4. Authentication</a></li><li class="sidebar-sub-header"><a href="/zum_pilot/Server/#_5-exception" class="sidebar-link">5. Exception</a></li></ul></li><li><a href="/zum_pilot/Reference/" class="sidebar-link">Reference</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="서버-사이드"><a href="#서버-사이드" class="header-anchor">#</a> 서버 사이드</h1> <h2 id="_1-crawling"><a href="#_1-crawling" class="header-anchor">#</a> 1. Crawling</h2> <p><code>SBS K-POP 뉴스</code> <code>빌보드코리아 뉴스</code> <code>멜론 차트</code> 등의 사이트를 크롤링 하는 과정에 대해 소개합니다.</p> <h3 id="jsoup"><a href="#jsoup" class="header-anchor">#</a> Jsoup</h3> <p>Crawling은 Jsoup을 활용했습니다. <code>Jsoup</code>은 <strong>java로 만들어지는 HTML Parser</strong>입니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Document</span> doc <span class="token operator">=</span> <span class="token class-name">Jsoup</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userAgent</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>이렇게 URL에 해당하는 DOM을 Parsing할 수 있으며, <strong>interface가 jQuery와 매우 유사합니다.</strong></p> <h3 id="flow-chart"><a href="#flow-chart" class="header-anchor">#</a> Flow Chart</h3> <img src="https://www.plantuml.com/plantuml/svg/ZPBFIiD04CRlUOevBmJlHQHGJu8exS6BbqqwD85qj-vkgju4lOYN21Qh1F4WU54eRK_Y4pNRTt12yySeYAU5RtxxVJEpszQ6AnCF8yUNKOI-2QNGq4LjEb8ObMkgKUgX6eS-DhIEugSvr-U6UrmZ7A7N2mqwJjC8t9toFhJ0Fa-onHBiuvsTlpkbJaXXLoEh-OMzl7PAdP0YW90kdiGK0juvCBQdPJnYh2AttGQfHzGj4cVmp6m5PXWHAoHLvPZeEjU5tODzEEHAXs9mB5pgOBPQV4Bs-hAUt5QzadrzPrFBahI2PzFrm_IRVprwX_i1ESFF_P3Xh_qKDl_O96FswMsppd8k5Gu2qmAVyX3ov_apaGm-4dkJqdcVsAkqp6wZwDCN-G80" alt="uml diagram"> <p>Crawling한 Data는 <code>Caching</code> 하여 재사용하여 <code>1분 동안 저장</code>합니다.</p> <p>Caching 후 1분 동안 요청이 오면 Cache에 저장된 data를 반환하고, 그 이후에는 다시 Jsoup을 통하여 크롤링을 수행합니다.</p> <h2 id="_2-youtube-search"><a href="#_2-youtube-search" class="header-anchor">#</a> 2. Youtube Search</h2> <p>크롤링 해온 <strong>음원</strong>에 대해 <strong>Youtube에 검색해서 동영상을 가져오는 과정</strong>에 대해 소개합니다.</p> <h3 id="api-request-cost"><a href="#api-request-cost" class="header-anchor">#</a> API Request Cost</h3> <p><code>Youtube Data API</code>를 통하여 Youtube에 있는 <code>동영상</code> <code>채널</code> <code>리소스</code> 등에 접근할 수 있습니다.</p> <p>그런데 Youtube Data API는 Youtube Service의 자원을 사용하기 때문에, 요청에 대한 제한이 있습니다.</p> <p><strong>하루에 <code>10000</code>의 할당량을 사용할 수 있으며, Request 종류별로 할당량에 대한 cost가 다릅니다.</strong></p> <p>공식 문서에서 요청에 대한 cost를 확인해볼 수 있는데, 정확한 수치가 아니라 <code>근삿값</code>입니다.</p> <p><img src="/zum_pilot/assets/img/cost.8ad69f35.jpg" alt="cost"></p> <p>이렇듯 <code>Search</code> 요청은 기본적으로 <code>100</code> 이상의 Cost를 지불해야합니다.</p> <p><img src="/zum_pilot/assets/img/cost2.382ba600.jpg" alt="cost2"></p> <p><code>한 개의 Search 요청</code>을 보낸 후 API 관리자에서 확인해본 결과, 실제로 <code>102</code>의 Cost를 지불합니다. 한도가 10000 이므로, <code>하루에 98회의 Search 요청</code>을 보낼 수 있습니다.</p> <h3 id="youtube-api-client-package"><a href="#youtube-api-client-package" class="header-anchor">#</a> Youtube API Client Package</h3> <p>Youtube는 API를 Client에서 사용하기 쉽게 Client Package를 제공합니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpRequestInitializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpTransport</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>http<span class="token punctuation">.</span>javanet</span><span class="token punctuation">.</span><span class="token class-name">NetHttpTransport</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>json</span><span class="token punctuation">.</span><span class="token class-name">JsonFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>client<span class="token punctuation">.</span>json<span class="token punctuation">.</span>jackson2</span><span class="token punctuation">.</span><span class="token class-name">JacksonFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>services<span class="token punctuation">.</span>youtube</span><span class="token punctuation">.</span><span class="token class-name">YouTube</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>services<span class="token punctuation">.</span>youtube<span class="token punctuation">.</span>model</span><span class="token punctuation">.</span><span class="token class-name">SearchResultSnippet</span><span class="token punctuation">;</span>

<span class="token comment">// { NetHttpTransprot, JacksonFactory } --&gt; 구글에서 제공하는 Client API</span>
<span class="token comment">// NetHttpTransport: java.net 패키지 기반의 Thread-safe http low-level Transport</span>
<span class="token comment">// JacksonFactory: Jackson2 기반의 low-level JSON library</span>
<span class="token keyword">private</span> <span class="token class-name">HttpTransport</span> HTTP_TRANSPORT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetHttpTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">JsonFactory</span> JSON_FACTORY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JacksonFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// API 사용에 필요한 Instance 생성</span>
<span class="token class-name">YouTube</span> youtube <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YouTube</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span>HTTP_TRANSPORT<span class="token punctuation">,</span> JSON_FACTORY<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setApplicationName</span><span class="token punctuation">(</span><span class="token string">&quot;youtube-cmdline-search-sample&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>그리고 Snippet에서 필요한 것들만 선택하여 가져오면 됩니다.</p> <div class="language-java extra-class"><pre class="language-java"><code>search
  <span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>API_KEY<span class="token punctuation">)</span> <span class="token comment">// 검색에 사용할 API KEY</span>
  <span class="token punctuation">.</span><span class="token function">setQ</span><span class="token punctuation">(</span>searchQuery<span class="token punctuation">)</span> <span class="token comment">// 검색어. 제목+가수 형태의 문자열을 넘김</span>
  <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 기본값: chnnel,playlist,video. 현재 필요한 것은 video</span>
  <span class="token punctuation">.</span><span class="token function">setMaxResults</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 검색된 목록에서 가져올 데이터의 수</span>
  <span class="token punctuation">.</span><span class="token function">setFields</span><span class="token punctuation">(</span><span class="token string">&quot;items(id/videoId,snippet(title,thumbnails/default/url))&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 결과로 가져올 필드</span>
  <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Search 실행 후 결과를 Video List에 Mapping</span>
  <span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">SearchResultSnippet</span> snippet <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">getSnippet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      <span class="token class-name">Video</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span>snippet<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">videoId</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVideoId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">thumbnail</span><span class="token punctuation">(</span>snippet<span class="token punctuation">.</span><span class="token function">getThumbnails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">searchTitle</span><span class="token punctuation">(</span>searchQuery<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="search-result-save"><a href="#search-result-save" class="header-anchor">#</a> Search Result Save</h3> <p><code>VideoService</code>의 일부 코드입니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*
 * 검색어(제목+가수) 기반으로 Video 정보를 가져옴
 * @param q : 검색어(제목+가수)
 * @return : Video Entity
 * @throws VideoNotFoundException : 동영상을 가져오는 과정에 오류가 발생했을 때 예외 처리
 */</span>
<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token string">&quot;VideoCache&quot;</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token string">&quot;#q&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Video</span> getBySearch <span class="token punctuation">(</span><span class="token class-name">String</span> q<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">VideoNotFoundException</span> <span class="token punctuation">{</span>
  <span class="token comment">// 일단 DB에 video가 있는지 탐색</span>
  <span class="token class-name">Video</span> video <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>videoRepository<span class="token punctuation">.</span><span class="token function">findBySearchTitle</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// DB에 없다면 Youtube Search</span>
    <span class="token class-name">Video</span> v <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>youtubeSearch<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span>
                      <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">VideoNotFoundException</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    videoRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> v<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 탐색해온 Video 정보 반환</span>
  <span class="token keyword">return</span> video<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>앞서 언급했듯이 <strong>API 요청에는 cost가 필요</strong>합니다.
그래서 중복 요청을 방지하기위해 이미 <strong>결과로 가져온 데이터는 DB에 저장하고, Caching 처리</strong> 합니다.
따라서 API 요청을 하기 위해선 일단 cache와 db를 거쳐야 합니다.</p> <h3 id="flow-chart-2"><a href="#flow-chart-2" class="header-anchor">#</a> Flow Chart</h3> <p>Youtube Search를 위한 과정은 다음과 같습니다.</p> <img src="https://www.plantuml.com/plantuml/svg/bLBDQeD04BxlKynPy0LAAI796mGAXLuskaJ1QZ1hpWdnKdAeWQQQ8f93IoyfsAIdaYVIoJjqhLMh0Q6dWTbllf-PxKmujRbpPv2ngBgYZwd9uLfNcTMpJ6vRXi7isjk0sLDTORNUZULmPyW6ZDgAHbJAwP1EMD4cG1g485yLF701wSC6Wpakve3RTNhu17n-nFqxAH02N1CG8yb-XejxV1BOhPikTyIqE0DhAgYRKBde0FfniezlJVbNe9IBLkX-aFfW9LhADH2NyXb2b3Wv726DWzCcQ37LWB-zdDOhA0DNpEL03aczi3Jzanl-Q5GBbQ7VHTyJc1b6hrdW7bKqtHoT7q98jHmYpm7_lPyaORJBTon9kKDR7saySwO89ooprE-scn4aNnukGr5z3zsmM6g7cQhuhzy0" alt="uml diagram"> <p>음원의 제목을 통해서 Youtube에 검색합니다. 검색 후 DB에 결과를 저장하고, 캐싱까지 합니다.</p> <p>그래서 동영상 정보를 재요청시 Cache나 DB에서 가져오게 됩니다.</p> <h2 id="_3-authorization"><a href="#_3-authorization" class="header-anchor">#</a> 3. Authorization</h2> <p>회원가입 후 로그인을 하면 다음과같은 과정으로 <code>JWT(Json Web Token)</code>을 발행합니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
* 토큰 생성
* @param userId : user의 id
* @param roles : user의 역할. 현재는 ROLE_USER 만 존재
* @return 토큰 값 반환
*/</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">claims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// claim 생성</span>
  claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;roles&quot;</span><span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// role 지정</span>
  <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span> <span class="token comment">// claim 지정</span>
          <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token comment">// 토큰 발행 일자 지정</span>
          <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> tokenValidMS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 유효 시간 지정</span>
          <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>HS256<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span> <span class="token comment">// 암호화 알고리즘, secret 값 지정</span>
          <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 위의 내용을 압축 후 반환</span>
<span class="token punctuation">}</span>

</code></pre></div><img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuN8goYylJYrIqBLJ20NIplbv9KNvEJb04Ik5ejJ2qjJY4WNzn89C_UBCz3pTp3mkD5LGVS6fHMMPoQb0JPuk-W7XN7dv9QaA-ML01LXa5LvjQdYpR2vEHMzdzRoPFK7XpOAfhpTlKKXBBKdEGBVMHXUldZSBMbvthy7YLg_ma82Y_BBC5B07FLsGt80g1UGfl6cU-wPb8nQhiIY5M0WBJQZpq4Apk20_hpXLGHVgMAXRjK46S3cavgK0umC0" alt="uml diagram"> <h2 id="_4-authentication"><a href="#_4-authentication" class="header-anchor">#</a> 4. Authentication</h2> <p>Authentication은 Spring Security의 Filter와 JWT를 이용합니다.</p> <p>먼저 spring security에서 <strong>filter를 정의</strong>합니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
* http 요청에 대해 처리하는 내용을 정의함
* @param http
* @throws Exception
*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> configure <span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
http
  <span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// spring-security에서 제공하는 /login 과 같은 페이지 비활성</span>
  <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Cross site request forgery 비활성</span>
  <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span> <span class="token comment">// session을 stateless 형태로 관리</span>
  <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token comment">// jwt를 이용하는 filter 추가</span>
    <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationFilter</span><span class="token punctuation">(</span>jwtTokenProvider<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// filter 사용</span>
<span class="token punctuation">}</span>
</code></pre></div><p>이렇게 모든 요청에 대해 <code>jwtAuthenticationFilter</code>를 통해 사전 검증을 합니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>
  <span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span>
  <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span>
  <span class="token class-name">FilterChain</span> chain
<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
  <span class="token comment">// request의 header에 포함된 Token 정보를 가져온다.</span>
  <span class="token class-name">String</span> token <span class="token operator">=</span> jwtTokenProvider<span class="token punctuation">.</span><span class="token function">resolveToken</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// token 정보가 존재할 때만 token을 검증</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> jwtTokenProvider<span class="token punctuation">.</span><span class="token function">validateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// token에서 값을 추출하여</span>
    <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> jwtTokenProvider<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// context에 저장한다.</span>
    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>이렇게 Request Header에 Token 정보가 있을 때만 Token 검증 후 Token에 담긴 Authentication을 Security Context에 저장합니다. 그리고 다음과 같이 사용됩니다.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AuthenticationCheck
 * @return
 * @throws AuthException
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">AuthenticationCheck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthException</span> <span class="token punctuation">{</span>
  <span class="token comment">// Security Context 에 저장한 authentication 정보 가져오기</span>
  <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Token 에서 가져온 User Id가 익명의 사용자일 경우 예외처리</span>
  <span class="token class-name">String</span> userId <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;anonymousUser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>즉, Security의 Authentication 정보는 기본 값이 항상 <code>anoymousUser</code>입니다. 이런식으로 User 권한이 필요할 때 Token 정보를 통해서 검증이 가능합니다.</p> <img src="https://www.plantuml.com/plantuml/svg/VL6zIWD14ExlAUO1p0k8I52miCofQT8iTuCkd3Fdx5pKtYuMWe8H4cn4B2mK4Mny8M_p3juQpiGxIRdx_JDTfqQqECwYBU5JXmATJOXpiNGOOrA8rNDOXnwU5EWq8bO47bQi5cN7PehXRnLfjxy7kH4NQ0smYZsmAV8samfdMIMlJJ45QHLea_yQ1WZFT42cq2CajObHo_GxSwFpZuMVVlZ7AVZHm-pooOycQmFojrVb_RF_l2cl9r2-Z6TtuwWfhBl7A4ERu9BHnUlNs_lSQ3-afaPDSyH25L38XHDqhXLI5rxGVvvpovMhUkXo9eTH5ocjJlqD" alt="uml diagram"> <h2 id="_5-exception"><a href="#_5-exception" class="header-anchor">#</a> 5. Exception</h2> <p>예외는 <code>Optional</code>과 Spring의 <code>RestControllerAdvice</code>와 예외처리에 대한 Response를 만들었습니다.</p> <p><code>ExceptionAdvice.java</code>의 일부입니다.</p> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@RestControllerAdvice</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionAdvice</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ResponseService</span> responseService<span class="token punctuation">;</span>

  <span class="token comment">/**
   * User select 에 대한 response 예외 처리
   * @param request
   * @param e
   * @return USER_FAIL
   */</span>
  <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">UserIdNotFoundException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
  <span class="token keyword">protected</span> <span class="token class-name">CommonResult</span> <span class="token function">userIdNotFoundException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> responseService<span class="token punctuation">.</span><span class="token function">failResult</span><span class="token punctuation">(</span><span class="token class-name">CommonResponse</span><span class="token punctuation">.</span>USER_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 나머지 생략</span>
<span class="token punctuation">}</span>
</code></pre></div><p>아래의 코드에서 예외가 발생하면 <code>ExceptionAdvice</code>에서 처리됩니다.</p> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-java"><code><span class="token comment">/**
 * 유저 정보가 Null 이면 Exception 처리, 아니면 유저 정보 반환
 * @param userId : User의 login ID
 * @return
 * @throws UserIdNotFoundException : 유저 정보 탐색에 대한 실패 처리
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UserIdNotFoundException</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token class-name">UserIdNotFoundException</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>즉, ExceptionAdvice.java에 정의된 Exception 이 발생하면 ExceptionAdvice가 바로 관련 Response 데이터를 만들고 바로 브라우저에 return 합니다.</p> <img src="https://www.plantuml.com/plantuml/svg/SoWkIImgAStDuN8goYylJYrIqBLJ278D3d4CyEJAooz9LSWl0mf2HHIi5DxCw7WpSuV2wmrptZJFvOA90pMvLYId5fHavkSvffHb9gS2bS9553mIyr9oKekG3CHK3J7upVG92gzx6jvEdQCGb5fSa9zNdAe0jEXDoqOkT2r0Es5kjbA8AG51hs1_FxW-BeVKl1IWpm00" alt="uml diagram"> <p><code>POST /api/video-like</code> 요청에 대한 예시입니다.</p> <p><img src="/zum_pilot/assets/img/response01.90c0e11d.jpg" alt="response01"></p> <p>이런 응답을 반환합니다. 여기에 <code>request-body</code>를 추가하면 다음과 같습니다.</p> <p><img src="/zum_pilot/assets/img/response02.f7286749.jpg" alt="response02"></p> <p>header에 JWT가 생략되었기 때문에 로그인이 필요하다는 응답을 반환합니다. 다시 header에 access token 정보를 담아서 요청하면</p> <p><img src="/zum_pilot/assets/img/response03.b98e5711.jpg" alt="response03"></p> <p>이렇게 정상적인 내용을 반환합니다.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zum_pilot/Client/Optimization/" class="prev">분석 및 최적화</a></span> <span class="next"><a href="/zum_pilot/Reference/">Reference</a>
      →
    </span></p></div> </main></div> <footer class="siteFooter"><p class="copyright">
      Copyright © 2019 <strong>zuminternet corp.</strong> All Right Reserved
    </p></footer></div><div class="global-ui"></div></div>
    <script src="/zum_pilot/assets/js/app.6c4eeaf4.js" defer></script><script src="/zum_pilot/assets/js/10.b9f48cc9.js" defer></script><script src="/zum_pilot/assets/js/2.1b64034b.js" defer></script><script src="/zum_pilot/assets/js/7.f435671a.js" defer></script>
  </body>
</html>
